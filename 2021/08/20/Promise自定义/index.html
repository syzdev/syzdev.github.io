<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;light&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.u1.huluxia.com/g3/M03/4D/84/wKgBOV6fGZWATbp6AAAML1Rr8NY150.png"><link rel="icon" href="https://cdn.u1.huluxia.com/g3/M03/4D/84/wKgBOV6fGZWATbp6AAAML1Rr8NY150.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="syz"><meta name="keywords" content=""><title>Promiseè‡ªå®šä¹‰ - syzdev</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/atom-one-dark.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"yoursite.com",root:"/",version:"1.8.10",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>ğŸ˜„ syzdev</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(https://cdn.u1.huluxia.com/g3/M02/4D/6C/wKgBOV6fEU2AXFGSAAJ7A1Fp7rw147.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Promiseè‡ªå®šä¹‰"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-08-20 14:44" pubdate>2021å¹´8æœˆ20æ—¥ ä¸‹åˆ</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 6k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 82 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Promiseè‡ªå®šä¹‰</h1><div class="markdown-body"><h1 id="1-å®šä¹‰åŸºæœ¬ç»“æ„"><a class="markdownIt-Anchor" href="#1-å®šä¹‰åŸºæœ¬ç»“æ„"></a> 1 å®šä¹‰åŸºæœ¬ç»“æ„</h1><p>ä¸‹é¢ä»£ç æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„Promiseå®ä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>  <span class="hljs-comment">// reject(&#x27;err&#x27;)</span><br>  <span class="hljs-comment">// throw &#x27;error&#x27;</span><br>&#125;)<br><br>p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(value) <span class="hljs-comment">// ok</span><br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä½¿ç”¨çš„æ˜¯å†…ç½®Promiseï¼Œè‹¥éœ€è‡ªå®šä¹‰ï¼Œåˆ™éœ€è¦è¦†ç›–å†…ç½®çš„Promiseï¼Œå³æ–°å»ºpromise.jsæ–‡ä»¶ï¼Œå¹¶åœ¨é¡µé¢ä¸­å¼•å…¥è¯¥æ–‡ä»¶ã€‚æ ¹æ®ä¸Šé¢çš„Promiseå®ä¾‹ï¼Œåœ¨åˆ›å»ºPromiseå¯¹è±¡æ—¶ä¼ å…¥äº†ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è‡ªå®šä¹‰ä¸­æˆ‘ä»¬æŠŠä»–å«åš<code>excutor</code>ï¼ŒPromiseå®ä¾‹ä¸Šè¿˜éœ€è¦æœ‰ä¸€ä¸ª<code>then</code>æ–¹æ³•ï¼Œå¹¶ä¸”æ¥å—ä¸¤ä¸ªå‡½æ•°å‚æ•°ï¼Œä»¥æ­¤å®šä¹‰äº†å¦‚ä¸‹çš„åŸºæœ¬ç»“æ„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Promise</span>(<span class="hljs-params">excutor</span>) </span>&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-built_in">Promise</span>.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onResolved, onRejected</span>) </span>&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="2-resolveä¸rejectçš„æ„å»º"><a class="markdownIt-Anchor" href="#2-resolveä¸rejectçš„æ„å»º"></a> 2 <code>resolve</code>ä¸<code>reject</code>çš„æ„å»º</h1><p>åœ¨Promiseæ„é€ å‡½æ•°ä¸­ï¼Œæ‰§è¡Œå™¨å‡½æ•°<code>excutor</code>æ˜¯åŒæ­¥è°ƒç”¨çš„ï¼Œè€Œ<code>excutor</code>åˆæ¥å—ä¸¤ä¸ªå‡½æ•°å‚æ•°<code>resolve</code>å’Œ<code>reject</code>ï¼Œæ‰€ä»¥è¯´éœ€è¦åœ¨æ„é€ å‡½æ•°å†…å£°æ˜è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯å¯ä»¥æ¥æ”¶å‚æ•°çš„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Promise</span>(<span class="hljs-params">excutor</span>) </span>&#123;<br>  <span class="hljs-comment">// æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§</span><br>  <span class="hljs-built_in">this</span>.PromiseState = <span class="hljs-string">&#x27;pending&#x27;</span><br>  <span class="hljs-built_in">this</span>.PromiseResult = <span class="hljs-literal">null</span><br>  <span class="hljs-comment">// ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window</span><br>  <span class="hljs-comment">// ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼</span><br>  <span class="hljs-keyword">const</span> self = <span class="hljs-built_in">this</span><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">data</span>) </span>&#123;<br>    <span class="hljs-comment">// 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]</span><br>    self.PromiseState = <span class="hljs-string">&#x27;fulfilled&#x27;</span><br>    <span class="hljs-comment">// 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]</span><br>    self.PromiseResult = data<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">data</span>) </span>&#123;<br>    <span class="hljs-comment">// 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]</span><br>    self.PromiseState = <span class="hljs-string">&#x27;rejected&#x27;</span><br>    <span class="hljs-comment">// 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]</span><br>    self.PromiseResult = data<br>  &#125;<br>  <span class="hljs-comment">// excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„</span><br>  excutor(resolve, reject)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="3-throwæŠ›å‡ºå¼‚å¸¸æ”¹å˜çŠ¶æ€"><a class="markdownIt-Anchor" href="#3-throwæŠ›å‡ºå¼‚å¸¸æ”¹å˜çŠ¶æ€"></a> 3 <code>throw</code>æŠ›å‡ºå¼‚å¸¸æ”¹å˜çŠ¶æ€</h1><p>æ”¹å˜Promiseå¯¹è±¡çš„çŠ¶æ€ä¸€å…±æœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ol><li><code>resolve</code>ï¼›</li><li><code>reject</code>ï¼›</li><li><code>throw</code>ï¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li></ol><p><code>resolve</code>å’Œ<code>reject</code>å‰ä¸€èŠ‚å·²ç»è®¨è®ºè¿‡äº†ã€‚å¯¹äº<code>throw</code>ï¼Œå¾ˆè‡ªç„¶çš„æƒ³åˆ°<code>try catch</code>è¯­æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸å®åœ¨æ‰§è¡Œå™¨å‡½æ•°æ‰§è¡Œçš„æ—¶å€™æŠ›å‡ºï¼Œæ‰€ä»¥éœ€è¦ç”¨<code>try catch</code>è¯­å¥å—åŒ…è£¹<code>excutor</code>æ‰§è¡Œå™¨å‡½æ•°ï¼Œæ—¢ç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œè¯´æ˜ä»»åŠ¡æ˜¯å¤±è´¥çš„ï¼Œæ‰€ä»¥åœ¨æ•æ‰å¼‚å¸¸çš„æ—¶å€™ï¼Œåˆ©ç”¨<code>reject</code>å‡½æ•°å°†Promiseå¯¹è±¡çš„çŠ¶æ€ç½®ä¸ºå¤±è´¥ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  function Promise(excutor) &#123;<br>    // æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§<br>    this.PromiseState = &#x27;pending&#x27;<br>    this.PromiseResult = null<br>    // ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window<br>    // ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼<br>    const self = this<br>    function resolve(data) &#123;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;fulfilled&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>    &#125;<br>    function reject(data) &#123;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;rejected&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>    &#125;<br><span class="hljs-addition">+    try &#123;</span><br><span class="hljs-addition">+      // excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„</span><br><span class="hljs-addition">+      excutor(resolve, reject)</span><br><span class="hljs-addition">+    &#125; catch (error) &#123;</span><br><span class="hljs-addition">+      // ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºå¤±è´¥</span><br><span class="hljs-addition">+      reject(error)</span><br><span class="hljs-addition">+    &#125;</span><br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="4-promiseå¯¹è±¡çš„çŠ¶æ€åªå…è®¸ä¿®æ”¹ä¸€æ¬¡"><a class="markdownIt-Anchor" href="#4-promiseå¯¹è±¡çš„çŠ¶æ€åªå…è®¸ä¿®æ”¹ä¸€æ¬¡"></a> 4 Promiseå¯¹è±¡çš„çŠ¶æ€åªå…è®¸ä¿®æ”¹ä¸€æ¬¡</h1><p>åŸç”Ÿçš„Promiseå¯¹è±¡çš„çŠ¶æ€æ˜¯åªå…è®¸ä¿®æ”¹ä¸€æ¬¡çš„ï¼Œä¸ºäº†å®ç°è¯¥ç‰¹æ€§ï¼Œè¦ä»<code>resolve</code>å’Œ<code>reject</code>ä¸‹æ‰‹ï¼Œå› ä¸ºæ”¹å˜Promiseå¯¹è±¡çŠ¶æ€çš„é€»è¾‘ä»£ç åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹ä¸­ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨æ¯æ¬¡æ”¹å˜çŠ¶æ€ä¹‹å‰è¿›è¡Œä¸€æ¬¡åˆ¤æ–­å³å¯ï¼Œåˆ¤æ–­è¯¥å¯¹è±¡çš„çŠ¶æ€æ˜¯å¦è¢«æ”¹è¿‡ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  function Promise(excutor) &#123;<br>    // æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§<br>    this.PromiseState = &#x27;pending&#x27;<br>    this.PromiseResult = null<br>    // ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window<br>    // ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼<br>    const self = this<br>    function resolve(data) &#123;<br><span class="hljs-addition">+      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡</span><br><span class="hljs-addition">+      if (self.PromiseState !== &#x27;pending&#x27;) &#123;</span><br><span class="hljs-addition">+        return</span><br><span class="hljs-addition">+      &#125;</span><br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;fulfilled&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>    &#125;<br>    function reject(data) &#123;<br><span class="hljs-addition">+      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡</span><br><span class="hljs-addition">+      if (self.PromiseState !== &#x27;pending&#x27;) &#123;</span><br><span class="hljs-addition">+        return</span><br><span class="hljs-addition">+      &#125;</span><br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;rejected&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>    &#125;<br>    try &#123;<br>      // excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„<br>      excutor(resolve, reject)<br>    &#125; catch (error) &#123;<br>      // ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºå¤±è´¥<br>      reject(error)<br>    &#125;<br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="5-thenæ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒ"><a class="markdownIt-Anchor" href="#5-thenæ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒ"></a> 5 <code>then</code>æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒ</h1><p><code>then</code>æ–¹æ³•çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onResolved, onRejected</span>) </span>&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></div></td></tr></table></figure><p>å…¶ä¸­<code>then</code>æ–¹æ³•ä¸­è¦å»æ‰§è¡Œ<code>onResolved</code>æˆ–<code>onRejected</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒï¼Œå› æ­¤éœ€è¦è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œè¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥çš„å±æ€§åªæœ‰<code>[[PromiseState]]</code>ï¼Œè¦åœ¨<code>then</code>æ–¹æ³•ä¸­è·å–è¯¥å±æ€§ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>this.PromiseState</code>ï¼Œå› ä¸º<code>then</code>æ–¹æ³•æ˜¯ç”±Promiseå¯¹è±¡å®ä¾‹æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥è¯¥<code>this</code>æŒ‡å‘è¯¥Promiseå®ä¾‹å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥å–åˆ°å¯¹è±¡ä¸Šçš„å±æ€§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onResolved, onRejected</span>) </span>&#123;<br>  <span class="hljs-comment">// åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;fulfilled&#x27;</span>) &#123;<br>    onResolved(<span class="hljs-built_in">this</span>.PromiseResult)<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;rejected&#x27;</span>) &#123;<br>    onRejected(<span class="hljs-built_in">this</span>.PromiseResult)<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="6-å¼‚æ­¥ä»»åŠ¡å›è°ƒçš„æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#6-å¼‚æ­¥ä»»åŠ¡å›è°ƒçš„æ‰§è¡Œ"></a> 6 å¼‚æ­¥ä»»åŠ¡å›è°ƒçš„æ‰§è¡Œ</h1><p>æœ¬èŠ‚å°†ç¬¬ä¸€èŠ‚ä¸­çš„åŸºæœ¬ç»“æ„æ”¹ä¸ºå¼‚æ­¥çš„å½¢å¼ï¼Œè¿™é‡Œä»¥å®šæ—¶å™¨ä¸ºä¾‹ï¼Œè®©<code>resolve</code>åœ¨1ç§’åæ‰§è¡Œï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>  &#125;, <span class="hljs-number">1000</span>);<br>&#125;)<br><br>p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰çš„Promiseæ— æ³•æ­£å¸¸æ‰§è¡Œï¼ŒåŸå› åœ¨äºä»£ç æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œåœ¨é‡åˆ°å®šæ—¶å™¨åï¼Œä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œåˆ°<code>then</code>æ–¹æ³•ï¼Œæ­¤æ—¶å› ä¸º<code>resolve</code>æ–¹æ³•æ²¡æœ‰æ‰§è¡Œï¼Œå³Promiseå¯¹è±¡çš„çŠ¶æ€æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥<code>then</code>æ–¹æ³•ä¹Ÿæ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚åœ¨æ‰§è¡Œåˆ°<code>then</code>æ–¹æ³•æ—¶ï¼ŒPromiseå¯¹è±¡çš„çŠ¶æ€å¤„äº<code>pending</code>çŠ¶æ€ï¼Œå› æ­¤è¦è§£å†³è¯¥é—®é¢˜ï¼Œéœ€è¦åœ¨<code>then</code>æ–¹æ³•çš„çŠ¶æ€åˆ¤æ–­ä¸­æ·»åŠ å¯¹äº<code>pending</code>çŠ¶æ€çš„åˆ¤æ–­ã€‚</p><p>ç”±äº<code>then</code>æ–¹æ³•ä¸­çš„<code>onResolved</code>å’Œ<code>onRejected</code>åœ¨æ”¹å˜çŠ¶æ€æ—¶è°ƒç”¨ï¼Œè€Œæ”¹å˜çŠ¶æ€åˆæ˜¯åœ¨<code>resolve</code>å’Œ<code>reject</code>ä¸­æ”¹å˜ï¼Œå³è¦åœ¨<code>resolve</code>å’Œ<code>reject</code>å†…è°ƒç”¨<code>onResolved</code>å’Œ<code>onRejected</code>ï¼Œç”±äº<code>resolve</code>å’Œ<code>reject</code>ä½äºPromiseæ„é€ å‡½æ•°ä¸­ï¼Œè€Œ<code>onResolved</code>å’Œ<code>onRejected</code>åœ¨<code>then</code>æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œä¸åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸã€‚ä¸ºäº†èƒ½å¤Ÿè®©<code>then</code>æ–¹æ³•ä¸­å¯ä»¥è°ƒç”¨<code>resolve</code>å’Œ<code>reject</code>ï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>then</code>æ–¹æ³•ä¸­ä¿å­˜å›è°ƒå‡½æ•°ï¼ˆä¹‹æ‰€ä»¥ä¿å­˜ï¼Œæ˜¯å› ä¸ºç”±äºæ‰§è¡Œçš„æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼Œæš‚æ—¶æ— æ³•ç¡®å®šä»»åŠ¡æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰ã€‚æœ€å¥½çš„åŠæ³•æ˜¯å°†å›è°ƒå‡½æ•°ä¿å­˜åœ¨å¯¹è±¡èº«ä¸Šï¼Œå³è¦åœ¨Promiseå¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ª<code>this.callback = &#123;&#125;</code>ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  function Promise(excutor) &#123;<br>    // æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§<br>    this.PromiseState = &#x27;pending&#x27;<br>    this.PromiseResult = null<br><span class="hljs-addition">+    // ä¿å­˜å›è°ƒçš„å±æ€§</span><br><span class="hljs-addition">+    this.callback = &#123;&#125;</span><br>    // ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window<br>    // ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼<br>    const self = this<br>    function resolve(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;fulfilled&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br><span class="hljs-addition">+      // è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°</span><br><span class="hljs-addition">+      if (self.callback.onResolved) &#123;</span><br><span class="hljs-addition">+        self.callback.onResolved(data)</span><br><span class="hljs-addition">+      &#125;</span><br>    &#125;<br>    function reject(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;rejected&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br><span class="hljs-addition">+      // è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°</span><br><span class="hljs-addition">+      if (self.callback.onRejected) &#123;</span><br><span class="hljs-addition">+        self.callback.onRejected(data)</span><br><span class="hljs-addition">+      &#125;</span><br>    &#125;<br>    try &#123;<br>      // excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„<br>      excutor(resolve, reject)<br>    &#125; catch (error) &#123;<br>      // ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºå¤±è´¥<br>      reject(error)<br>    &#125;<br>  &#125;<br><br>  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>    if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br>      onResolved(this.PromiseResult)<br>    &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br>      onRejected(this.PromiseResult)<br><span class="hljs-addition">+    &#125; else if (this.PromiseState === &#x27;pending&#x27;) &#123;</span><br><span class="hljs-addition">+      // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br><span class="hljs-addition">+      this.callback = &#123;</span><br><span class="hljs-addition">+        onResolved,</span><br><span class="hljs-addition">+        onRejected</span><br><span class="hljs-addition">+      &#125;</span><br>    &#125;<br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="7-æŒ‡å®šå¤šä¸ªå›è°ƒçš„å®ç°"><a class="markdownIt-Anchor" href="#7-æŒ‡å®šå¤šä¸ªå›è°ƒçš„å®ç°"></a> 7 æŒ‡å®šå¤šä¸ªå›è°ƒçš„å®ç°</h1><p>åœ¨åŸç”ŸPromiseä¸­ï¼Œåªè¦çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆå…¶æŒ‡å®šçš„å¤šä¸ªå›è°ƒéƒ½æ˜¯ä¼šæ‰§è¡Œçš„ï¼Œè€Œä¸Šè¿°çš„è‡ªå®šä¹‰Promiseä¸­åªä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªå›è°ƒï¼Œå› ä¸ºæ¯æ¬¡åœ¨æ”¹å˜çŠ¶æ€æ—¶ï¼Œä¼šå°†å›è°ƒå‡½æ•°ä¿å­˜ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br><span class="hljs-built_in">this</span>.callback = &#123;<br>  onResolved,<br>  onRejected<br>&#125;<br></code></pre></div></td></tr></table></figure><p>è€Œå¯¹äºæŒ‡å®šäº†å¤šä¸ªå›è°ƒçš„Promiseå¯¹è±¡å®ä¾‹ï¼Œåªä¼šæ‰§è¡Œæœ€åä¸€ä¸ªè¢«æŒ‡å®šçš„å›è°ƒï¼Œå› ä¸ºä¹‹å‰è¢«æŒ‡å®šçš„å›è°ƒéƒ½è¢«é€ä¸€è¦†ç›–æ‰äº†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br><br>p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  alert(value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  alert(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>æ˜¾ç„¶ä¹‹å‰çš„ä¿å­˜å›è°ƒçš„æ–¹å¼æ˜¯ä¸å¤Ÿå®Œå–„çš„ï¼Œå› æ­¤è§£å†³åŠæ³•å°±æ˜¯æŠŠæ‰€æœ‰æŒ‡å®šçš„å›è°ƒç”¨æ•°ç»„éƒ½ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œçš„æ—¶å€™åˆ©ç”¨éå†æ‰§è¡Œæ‰€æœ‰çš„å›è°ƒï¼š</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  function Promise(excutor) &#123;<br>    // æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§<br>    this.PromiseState = &#x27;pending&#x27;<br>    this.PromiseResult = null<br><span class="hljs-addition">+    // ä¿å­˜å›è°ƒçš„å±æ€§</span><br><span class="hljs-addition">+    this.callbacks = []</span><br>    // ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window<br>    // ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼<br>    const self = this<br>    function resolve(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;fulfilled&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br><span class="hljs-addition">+      // è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°</span><br><span class="hljs-addition">+      self.callbacks.forEach(item =&gt; &#123;</span><br><span class="hljs-addition">+        item.onResolved(data)</span><br><span class="hljs-addition">+      &#125;)</span><br>    &#125;<br>    function reject(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;rejected&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br><span class="hljs-addition">+      // è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°</span><br><span class="hljs-addition">+      self.callbacks.forEach(item =&gt; &#123;</span><br><span class="hljs-addition">+        item.onRejected(data)</span><br><span class="hljs-addition">+      &#125;)</span><br>    &#125;<br>    try &#123;<br>      // excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„<br>      excutor(resolve, reject)<br>    &#125; catch (error) &#123;<br>      // ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºå¤±è´¥<br>      reject(error)<br>    &#125;<br>  &#125;<br><br>  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>    if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br>      onResolved(this.PromiseResult)<br>    &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br>      onRejected(this.PromiseResult)<br>    &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;pending&#x27;) &#123;</span><br><span class="hljs-addition">+      // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br><span class="hljs-addition">+      this.callback.push(&#123;</span><br><span class="hljs-addition">+        onResolved,</span><br><span class="hljs-addition">+        onRejected</span><br><span class="hljs-addition">+      &#125;)</span><br>    &#125;<br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="8-åŒæ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€thenæ–¹æ³•çš„è¿”å›ç»“æœ"><a class="markdownIt-Anchor" href="#8-åŒæ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€thenæ–¹æ³•çš„è¿”å›ç»“æœ"></a> 8 åŒæ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€<code>then</code>æ–¹æ³•çš„è¿”å›ç»“æœ</h1><p>åœ¨åŸç”ŸPromiseä¸­<code>then</code>æ–¹æ³•çš„è¿”å›ç»“æœæ˜¯ç”±å®ƒæŒ‡å®šçš„å›è°ƒå‡½æ•°çš„è¿”å›ç»“æœå†³å®šçš„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>&#125;)<br><br><span class="hljs-keyword">const</span> result = p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br><br><span class="hljs-built_in">console</span>.log(result)<br></code></pre></div></td></tr></table></figure><ul><li>è‹¥å›è°ƒå‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªéPromiseç±»å‹çš„æ•°æ®ï¼Œåˆ™<code>result</code>ä¸ºä¸€ä¸ªæˆåŠŸçš„Promiseï¼Œå…¶ç»“æœå€¼ä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œè¿™é‡Œæ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥å…¶ç»“æœå€¼ä¸º<code>undefined</code></li><li>è‹¥è¿”å›çš„å°±æ˜¯ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œåˆ™è¯¥å¯¹è±¡å†³å®šäº†<code>result</code>çš„ç»“æœä¸çŠ¶æ€ã€‚</li></ul><p>é¦–å…ˆéœ€è¦ç¡®å®šçš„æ˜¯ï¼Œ<code>then</code>æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œ è€Œæˆ‘ä»¬è‡ªå®šä¹‰çš„<code>then</code>æ–¹æ³•ä¸­éœ€è¦æ·»åŠ è¿”å›å€¼ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªPromiseç±»å‹çš„è¿”å›å€¼ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    return new Promise((resolve, reject) =&gt; &#123;<br>      // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>      if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br><span class="hljs-addition">+        try &#123;</span><br><span class="hljs-addition">+          // è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br><span class="hljs-addition">+          let result = onResolved(this.PromiseResult)</span><br><span class="hljs-addition">+          if (result instanceof Promise) &#123;</span><br><span class="hljs-addition">+            // resultä¸ºPromiseå¯¹è±¡</span><br><span class="hljs-addition">+            // å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ</span><br><span class="hljs-addition">+            result.then(value =&gt; &#123;</span><br><span class="hljs-addition">+              resolve(value)</span><br><span class="hljs-addition">+            &#125;, reason =&gt; &#123;</span><br><span class="hljs-addition">+              reject(reason)</span><br><span class="hljs-addition">+            &#125;)</span><br><span class="hljs-addition">+          &#125; else &#123;</span><br><span class="hljs-addition">+            // resultä¸ºéPromiseç±»å‹çš„æ•°æ®</span><br><span class="hljs-addition">+            // å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ</span><br><span class="hljs-addition">+            resolve(result)</span><br><span class="hljs-addition">+          &#125;   </span><br><span class="hljs-addition">+        &#125; catch (error) &#123;</span><br><span class="hljs-addition">+          // ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥</span><br><span class="hljs-addition">+          reject(error)</span><br><span class="hljs-addition">+        &#125;</span><br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br>        onRejected(this.PromiseResult)<br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;pending&#x27;) &#123;</span><br>        // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š<br>        this.callback.push(&#123;<br>          onResolved,<br>          onRejected<br>        &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="9-å¼‚æ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€thenæ–¹æ³•çš„è¿”å›ç»“æœ"><a class="markdownIt-Anchor" href="#9-å¼‚æ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€thenæ–¹æ³•çš„è¿”å›ç»“æœ"></a> 9 å¼‚æ­¥ä»»åŠ¡ä¸‹ä¿®æ”¹çŠ¶æ€<code>then</code>æ–¹æ³•çš„è¿”å›ç»“æœ</h1><p>å½“ä»»åŠ¡ä¸ºå¼‚æ­¥ä»»åŠ¡æ—¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  	resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>  &#125;, <span class="hljs-number">1000</span>);<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹<code>p</code>ä¸€ç›´å¤„äº<code>pending</code>çŠ¶æ€ï¼Œ åœ¨è‡ªå®šä¹‰<code>then</code>æ–¹æ³•ä¸­ï¼Œå¯¹äº<code>pending</code>çš„çŠ¶æ€ä¸‹å¹¶æ²¡æœ‰è°ƒç”¨<code>resolve</code>æˆ–<code>reject</code>ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;pending&#x27;</span>) &#123;<br>  <span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br>  <span class="hljs-built_in">this</span>.callback.push(&#123;<br>    onResolved,<br>    onRejected<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>å› æ­¤éœ€è¦æ ¹æ®å›è°ƒå‡½æ•°çš„ç»“æœæ¥æ”¹å˜Promiseå¯¹è±¡çš„çŠ¶æ€å’Œç»“æœå€¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onResolved, onRejected</span>) </span>&#123;<br>  <span class="hljs-keyword">const</span> self = <span class="hljs-built_in">this</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;fulfilled&#x27;</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>        <span class="hljs-keyword">let</span> result = onResolved(<span class="hljs-built_in">this</span>.PromiseResult)<br>        <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>          <span class="hljs-comment">// resultä¸ºPromiseå¯¹è±¡</span><br>          <span class="hljs-comment">// å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ</span><br>          result.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            resolve(value)<br>          &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>            reject(reason)<br>          &#125;)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// resultä¸ºéPromiseç±»å‹çš„æ•°æ®</span><br>          <span class="hljs-comment">// å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ</span><br>          resolve(result)<br>        &#125;   <br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-comment">// ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥</span><br>        reject(error)<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;rejected&#x27;</span>) &#123;<br>      onRejected(<span class="hljs-built_in">this</span>.PromiseResult)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;pending&#x27;</span>) &#123;<br>      <span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br>      <span class="hljs-built_in">this</span>.callback.push(&#123;<br>        <span class="hljs-comment">// å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼ˆå‰é¢forEachè¯­å¥è°ƒç”¨ï¼‰</span><br>        onResolved: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°</span><br>            <span class="hljs-keyword">let</span> result = onResolved(self.PromiseResult)<br>            <span class="hljs-comment">// ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€</span><br>            <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>              result.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>                resolve(value)<br>              &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>                reject(reason)<br>              &#125;)<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              resolve(result)<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125;<br>        &#125;,<br>        onRejected: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°</span><br>            <span class="hljs-keyword">let</span> result = onRejected(self.PromiseResult)<br>            <span class="hljs-comment">// ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€</span><br>            <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>              result.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>                resolve(value)<br>              &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>                reject(reason)<br>              &#125;)<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              resolve(result)<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>            reject(error)<br>          &#125;<br>        &#125;<br>      &#125;)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="10-thenæ–¹æ³•çš„è¡¥å……å’Œä¼˜åŒ–"><a class="markdownIt-Anchor" href="#10-thenæ–¹æ³•çš„è¡¥å……å’Œä¼˜åŒ–"></a> 10 <code>then</code>æ–¹æ³•çš„è¡¥å……å’Œä¼˜åŒ–</h1><p>æ·»åŠ å¤„ç†å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œthenæ–¹æ³•çš„è¿”å›ç»“æœï¼Œå¤„ç†æ–¹æ³•ç±»ä¼¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;rejected&#x27;</span>) &#123;<br>  <span class="hljs-comment">// å¤„ç†å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œthenæ–¹æ³•çš„è¿”å›ç»“æœ</span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">let</span> result = onRejected(<span class="hljs-built_in">this</span>.PromiseResult)<br>    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>      result.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        resolve(value)<br>      &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        reject(reason)<br>      &#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      resolve(result)<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    reject(error)<br>  &#125;<br></code></pre></div></td></tr></table></figure><p>å¯ä»¥å‘ç°ç±»ä¼¼çš„<code>try catch</code>è¯­å¥æœ‰å¾ˆå¤šï¼Œå¹¶ä¸”éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠŠç±»ä¼¼çš„é€»è¾‘è¿›è¡Œå°è£…ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.prototype.then = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onResolved, onRejected</span>) </span>&#123;<br>  <span class="hljs-keyword">const</span> self = <span class="hljs-built_in">this</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// å°è£…try catchä¸­çš„é€»è¾‘</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callback</span>(<span class="hljs-params">type</span>) </span>&#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br>        <span class="hljs-keyword">let</span> result = type(self.PromiseResult)<br>        <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>          <span class="hljs-comment">// resultä¸ºPromiseå¯¹è±¡</span><br>          <span class="hljs-comment">// å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ</span><br>          result.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            resolve(value)<br>          &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>            reject(reason)<br>          &#125;)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// resultä¸ºéPromiseç±»å‹çš„æ•°æ®</span><br>          <span class="hljs-comment">// å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ</span><br>          resolve(result)<br>        &#125;   <br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-comment">// ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥</span><br>        reject(error)<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;fulfilled&#x27;</span>) &#123;<br>      callback(onResolved)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;rejected&#x27;</span>) &#123;<br>      callback(onRejected)<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.PromiseState === <span class="hljs-string">&#x27;pending&#x27;</span>) &#123;<br>      <span class="hljs-comment">// ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š</span><br>      <span class="hljs-built_in">this</span>.callback.push(&#123;<br>        <span class="hljs-comment">// å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼ˆå‰é¢forEachè¯­å¥è°ƒç”¨ï¼‰</span><br>        onResolved: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          callback(onRejected)<br>        &#125;,<br>        onRejected: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          callback(onRejected)<br>        &#125;<br>      &#125;)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="11-catchæ–¹æ³•çš„å¼‚å¸¸ç©¿é€ä¸å€¼ä¼ é€’"><a class="markdownIt-Anchor" href="#11-catchæ–¹æ³•çš„å¼‚å¸¸ç©¿é€ä¸å€¼ä¼ é€’"></a> 11 <code>catch</code>æ–¹æ³•çš„å¼‚å¸¸ç©¿é€ä¸å€¼ä¼ é€’</h1><p><code>catch</code>æ–¹æ³•çš„ä½¿ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  reject(<span class="hljs-string">&#x27;err&#x27;</span>)<br>&#125;)<br>p.catch(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>è‹¥åªéœ€è¦å®ç°<code>catch</code>æ•æ‰å¤±è´¥åŠŸèƒ½ï¼Œä¸‹é¢ä»£ç å³å¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.prototype.catch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">onRejected</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.then(<span class="hljs-literal">undefined</span>, onRejected)<br>&#125;<br></code></pre></div></td></tr></table></figure><p>åœ¨åŸç”ŸPromiseä¸­è¿è¡Œåªä¼ å…¥<code>onResolved</code>å‚æ•°ï¼Œä¸ä¼ å…¥<code>onRejected</code>å‚æ•°ï¼Œå³ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>)<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>)<br>&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>)<br>&#125;).catch(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>å®ç°å¼‚å¸¸ç©¿é€éœ€è¦ä¿®æ”¹<code>then</code>æ–¹æ³•ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    const self = this<br><span class="hljs-addition">+    // åˆ¤æ–­å›è°ƒå‡½æ•°çš„å‚æ•°</span><br><span class="hljs-addition">+    if (typeof onRejected !== &#x27;function&#x27;) &#123;</span><br><span class="hljs-addition">+      onRejected = reason =&gt; &#123;</span><br><span class="hljs-addition">+        throw reason</span><br><span class="hljs-addition">+      &#125;</span><br>    &#125;<br>    return new Promise((resolve, reject) =&gt; &#123;<br>      // å°è£…try catchä¸­çš„é€»è¾‘<br>      function callback(type) &#123;<br>        try &#123;<br>          // è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ<br>          let result = type(self.PromiseResult)<br>          if (result instanceof Promise) &#123;<br>            // resultä¸ºPromiseå¯¹è±¡<br>            // å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ<br>            result.then(value =&gt; &#123;<br>              resolve(value)<br>            &#125;, reason =&gt; &#123;<br>              reject(reason)<br>            &#125;)<br>          &#125; else &#123;<br>            // resultä¸ºéPromiseç±»å‹çš„æ•°æ®<br>            // å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ<br>            resolve(result)<br>          &#125;   <br>        &#125; catch (error) &#123;<br>          // ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥<br>          reject(error)<br>        &#125;<br>      &#125;<br>      // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>      if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br>        callback(onResolved)<br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br>        callback(onRejected)<br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;pending&#x27;) &#123;</span><br>        // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š<br>        this.callback.push(&#123;<br>          // å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼ˆå‰é¢forEachè¯­å¥è°ƒç”¨ï¼‰<br>          onResolved: function () &#123;<br>            callback(onRejected)<br>          &#125;,<br>          onRejected: function () &#123;<br>            callback(onRejected)<br>          &#125;<br>        &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;<br></code></pre></div></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ç›¸å½“äºåœ¨æ²¡æœ‰ä¼ é€’<code>onRejected</code>å‚æ•°æ—¶æ‰‹åŠ¨æ·»åŠ å¤±è´¥æ—¶çš„å¤„ç†æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">p.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">throw</span> reason<br>&#125;).catch(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>å¦å¤–ï¼Œåœ¨åŸç”ŸPromiseä¸­<code>then</code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿå¯ä»¥çœç•¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">p.then().catch(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(reason)<br>&#125;)<br></code></pre></div></td></tr></table></figure><p>å®ç°è¯¥åŠŸèƒ½çš„æ–¹æ³•ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œè‹¥æ²¡æœ‰ä¼ å…¥å‚æ•°ï¼Œåˆ™æ·»åŠ åˆ¤æ–­ï¼Œæ‰‹åŠ¨æ·»åŠ å¤„ç†æˆåŠŸæ—¶çš„æ–¹æ³•ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    const self = this<br>    // åˆ¤æ–­å›è°ƒå‡½æ•°çš„å‚æ•°<br>    if (typeof onRejected !== &#x27;function&#x27;) &#123;<br>      onRejected = reason =&gt; &#123;<br>        throw reason<br>      &#125;<br>    &#125;<br><span class="hljs-addition">+    if (typeof onResolved !== &#x27;function&#x27;) &#123;</span><br><span class="hljs-addition">+      onResolved = value =&gt; value</span><br><span class="hljs-addition">+    &#125;</span><br>    return new Promise((resolve, reject) =&gt; &#123;<br>      // å°è£…try catchä¸­çš„é€»è¾‘<br>      function callback(type) &#123;<br>        try &#123;<br>          // è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ<br>          let result = type(self.PromiseResult)<br>          if (result instanceof Promise) &#123;<br>            // resultä¸ºPromiseå¯¹è±¡<br>            // å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ<br>            result.then(value =&gt; &#123;<br>              resolve(value)<br>            &#125;, reason =&gt; &#123;<br>              reject(reason)<br>            &#125;)<br>          &#125; else &#123;<br>            // resultä¸ºéPromiseç±»å‹çš„æ•°æ®<br>            // å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ<br>            resolve(result)<br>          &#125;   <br>        &#125; catch (error) &#123;<br>          // ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥<br>          reject(error)<br>        &#125;<br>      &#125;<br>      // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>      if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br>        callback(onResolved)<br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br>        callback(onRejected)<br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;pending&#x27;) &#123;</span><br>        // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š<br>        this.callback.push(&#123;<br>          // å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼ˆå‰é¢forEachè¯­å¥è°ƒç”¨ï¼‰<br>          onResolved: function () &#123;<br>            callback(onRejected)<br>          &#125;,<br>          onRejected: function () &#123;<br>            callback(onRejected)<br>          &#125;<br>        &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;<br></code></pre></div></td></tr></table></figure><h1 id="12-resolveæ–¹æ³•çš„å°è£…"><a class="markdownIt-Anchor" href="#12-resolveæ–¹æ³•çš„å°è£…"></a> 12 <code>resolve</code>æ–¹æ³•çš„å°è£…</h1><p>åŸç”ŸPromiseä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨<code>resolve</code>æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ªPromiseå¯¹è±¡ï¼Œè‹¥ä¼ å…¥çš„å‚æ•°æ˜¯éPromiseç±»å‹çš„æ•°æ®ï¼Œç»“æœä¸ºæˆåŠŸï¼Œç»“æœå€¼ä¸ºä¼ å…¥çš„å€¼ï¼Œè‹¥ä¼ å…¥çš„æ•°æ®æ˜¯Promiseç±»å‹çš„æ•°æ®ï¼Œåˆ™è¯¥æ•°æ®çš„å€¼å°±æ˜¯æœ€ç»ˆçš„è¿”å›å€¼ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> p = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>å°è£…å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>resolve</code>æ–¹æ³•å¹¶éPromiseå¯¹è±¡å®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥ä¸éœ€è¦æ·»åŠ åˆ°<code>prototype</code>åŸå‹é“¾ä¸Šï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.resolve = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>&#123;<br>  <span class="hljs-comment">// è¿”å›Promiseå¯¹è±¡</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Promise</span>) &#123;<br>      <span class="hljs-comment">// ä¼ å…¥çš„æ•°æ®æ˜¯Promiseç±»å‹çš„æ•°æ®ï¼Œåˆ™è¯¥æ•°æ®çš„å€¼å°±æ˜¯æœ€ç»ˆçš„è¿”å›å€¼</span><br>      value.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        resolve(value)<br>      &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        reject(reason)<br>      &#125;)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// ä¼ å…¥çš„å‚æ•°æ˜¯éPromiseç±»å‹çš„æ•°æ®ï¼Œç»“æœä¸ºæˆåŠŸï¼Œç»“æœå€¼ä¸ºä¼ å…¥çš„å€¼</span><br>      resolve(value)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="13-rejectæ–¹æ³•å°è£…"><a class="markdownIt-Anchor" href="#13-rejectæ–¹æ³•å°è£…"></a> 13 <code>reject</code>æ–¹æ³•å°è£…</h1><p><code>reject</code>æ–¹æ³•è¿”å›çš„æ°¸è¿œéƒ½æ˜¯ä¸€ä¸ªå¤±è´¥çŠ¶æ€çš„Promiseå¯¹è±¡ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.reject = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    reject(reason)<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="14-allæ–¹æ³•å°è£…"><a class="markdownIt-Anchor" href="#14-allæ–¹æ³•å°è£…"></a> 14 <code>all</code>æ–¹æ³•å°è£…</h1><p>åŸç”ŸPromiseä¸­è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseï¼Œåªæœ‰æ‰€æœ‰çš„Promiseéƒ½æˆåŠŸæ‰ç®—æˆåŠŸï¼Œåªè¦æœ‰ä¸€ä¸ªPromiseå¤±è´¥å°±ç›´æ¥å¤±è´¥äº†ï¼Œå¦‚ä¸‹é¢ä¾‹å­ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>&#125;)<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;good&#x27;</span>)<br><span class="hljs-keyword">let</span> p3 = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;fine&#x27;</span>)<br><span class="hljs-keyword">const</span> result = <span class="hljs-built_in">Promise</span>.all([p1, p2, p3])<br><span class="hljs-built_in">console</span>.log(result) <span class="hljs-comment">// fulfilled</span><br></code></pre></div></td></tr></table></figure><p>å°è£…å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.all = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">promises</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºç»Ÿè®¡æˆåŠŸæ•°é‡çš„å˜é‡</span><br>    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span><br>    <span class="hljs-comment">// ç”¨äºä¿å­˜æˆåŠŸçš„ç»“æœï¼ŒæˆåŠŸçš„ç»“æœä¸ºæ‰€æœ‰PromiseæˆåŠŸçš„ç»“æœå€¼æ•°ç»„</span><br>    <span class="hljs-keyword">let</span> resultArray = []<br>    <span class="hljs-comment">// åˆ¤æ–­promisesä¸­çš„æ‰€æœ‰Promiseå¯¹è±¡æ˜¯å¦éƒ½æˆåŠŸ</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; promises.length; i++) &#123;<br>      promises[i].then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// æˆåŠŸæ—¶æ‰§è¡Œçš„ä»£ç </span><br>        <span class="hljs-comment">// å½“æ¯ä¸€ä¸ªPromiseå¯¹è±¡éƒ½æˆåŠŸæ—¶ï¼Œæ‰èƒ½æ‰§è¡Œresolve</span><br>        count++<br>        <span class="hljs-comment">// å°†å½“å‰Promiseå¯¹è±¡çš„ç»“æœä¿å­˜åˆ°æ•°ç»„ä¸­</span><br>        <span class="hljs-comment">// ä½¿ç”¨ä¸‹æ ‡è€Œä¸æ˜¯pushçš„æ–¹å¼æ˜¯ä¸ºäº†ä¿æŒç»“æœå€¼ä¸Promiseå¯¹è±¡åœ¨æ•°ç»„ä¸­ä¸‹æ ‡æ­£ç¡®å¯¹åº”</span><br>        resultArray[i] = value<br>        <span class="hljs-keyword">if</span> (count === promises.length) &#123;<br>          <span class="hljs-comment">// æ‰€æœ‰Promiseå¯¹è±¡éƒ½æˆåŠŸäº†</span><br>          resolve(resultArray)<br>        &#125;<br>      &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// å¤±è´¥æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œåªè¦æœ‰ä¸€ä¸ªå¤±è´¥ï¼Œå°±è¿”å›å¤±è´¥</span><br>        reject(reason)<br>      &#125;)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="15-raceæ–¹æ³•çš„å°è£…"><a class="markdownIt-Anchor" href="#15-raceæ–¹æ³•çš„å°è£…"></a> 15 <code>race</code>æ–¹æ³•çš„å°è£…</h1><p>åœ¨åŸç”ŸPromiseä¸­è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„Promiseï¼Œç¬¬ä¸€ä¸ªå®Œæˆçš„Promiseçš„ç»“æœçŠ¶æ€å°±æ˜¯æœ€ç»ˆçš„ç»“æœçŠ¶æ€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>&#125;)<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;good&#x27;</span>)<br><span class="hljs-keyword">let</span> p3 = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&#x27;fine&#x27;</span>)<br><span class="hljs-keyword">const</span> result = <span class="hljs-built_in">Promise</span>.race([p1, p2, p3])<br><span class="hljs-built_in">console</span>.log(result) <span class="hljs-comment">// fulfilled ok</span><br></code></pre></div></td></tr></table></figure><p>å°è£…å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-built_in">Promise</span>.race = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">promises</span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; promises.length; i++) &#123;<br>      promises[i].then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// é‡åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸçš„Promiseç›´æ¥è¿”å›</span><br>        resolve(value)<br>      &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        reject(reason)<br>      &#125;)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></div></td></tr></table></figure><h1 id="16-thenæ–¹æ³•å›è°ƒçš„å¼‚æ­¥æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#16-thenæ–¹æ³•å›è°ƒçš„å¼‚æ­¥æ‰§è¡Œ"></a> 16 <code>then</code>æ–¹æ³•å›è°ƒçš„å¼‚æ­¥æ‰§è¡Œ</h1><p>åœ¨åŸç”ŸPromiseä¸­<code>then</code>æ–¹æ³•å›è°ƒçš„å¼‚æ­¥æ‰§è¡ŒæŒ‡çš„æ˜¯æ‰§è¡Œ<code>then</code>æ–¹æ³•æ—¶ä¼ å…¥çš„<code>onResolved</code>å’Œ<code>onRejected</code>ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  resolve(<span class="hljs-string">&#x27;ok&#x27;</span>)<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>)<br>&#125;)<br><br>p1.then(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>)<br>&#125;)<br><br><span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>)<br></code></pre></div></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„è¾“å‡ºé¡ºåºä¸º132ï¼Œå…¶ä¸­<code>console.log(2)</code>æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå®ƒè¦ç­‰éƒ½æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œç»“æŸä¹‹åæ‰èƒ½æ‰§è¡Œã€‚<br>ä¸ºäº†ä½¿å…¶èƒ½å¤Ÿæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨<code>setTimeout</code>å®šæ—¶å™¨åŒ…è£¹<code>onResolved</code>å’Œ<code>onRejected</code>è°ƒç”¨çš„åœ°æ–¹ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs diff">  function Promise(excutor) &#123;<br>    // æ·»åŠ å¯¹è±¡çŠ¶æ€ä¸å¯¹è±¡ç»“æœå€¼å±æ€§<br>    this.PromiseState = &#x27;pending&#x27;<br>    this.PromiseResult = null<br>    // ä¿å­˜å›è°ƒçš„å±æ€§<br>    this.callbacks = []<br>    // ç”±äºresolveå’Œrejectéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ï¼Œæ‰€ä»¥thisçš„å€¼æ˜¯Window<br>    // ä¸ºäº†å–åˆ°å®ä¾‹å¯¹è±¡å†…çš„å±æ€§ï¼Œéœ€è¦æå‰ä¿å­˜thisçš„å€¼<br>    const self = this<br>    function resolve(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;fulfilled&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>      // è°ƒç”¨æˆåŠŸçš„å›è°ƒå‡½æ•°<br><span class="hljs-addition">+      setTimeout(() =&gt; &#123;</span><br>        self.callbacks.forEach(item =&gt; &#123;<br>          item.onResolved(data)<br>        &#125;)<br><span class="hljs-addition">+      &#125;)</span><br>    &#125;<br>    function reject(data) &#123;<br>      // åˆ¤æ–­Promiseå¯¹è±¡çš„çŠ¶æ€ï¼Œå®ç°çŠ¶æ€åªèƒ½ä¿®æ”¹ä¸€æ¬¡<br>      if (self.PromiseState !== &#x27;pending&#x27;) &#123;<br>        return<br>      &#125;<br>      // 1.ä¿®æ”¹å¯¹è±¡çš„çŠ¶æ€ [[PromiseState]]<br>      self.PromiseState = &#x27;rejected&#x27;<br>      // 2.è®¾ç½®å¯¹è±¡ç»“æœå€¼ [[PromiseResult]]<br>      self.PromiseResult = data<br>      // è°ƒç”¨å¤±è´¥çš„å›è°ƒå‡½æ•°<br><span class="hljs-addition">+      setTimeout(() =&gt; &#123;</span><br>        self.callbacks.forEach(item =&gt; &#123;<br>          item.onRejected(data)<br>        &#125;)<br><span class="hljs-addition">+      &#125;)</span><br>    &#125;<br>    try &#123;<br>      // excutor æ‰§è¡Œå™¨å‡½æ•°æ˜¯åŒæ­¥è°ƒç”¨çš„<br>      excutor(resolve, reject)<br>    &#125; catch (error) &#123;<br>      // ä¿®æ”¹Promiseå¯¹è±¡çš„çŠ¶æ€ä¸ºå¤±è´¥<br>      reject(error)<br>    &#125;<br>  &#125;<br><br>  Promise.prototype.then = function(onResolved, onRejected) &#123;<br>    const self = this<br>    // åˆ¤æ–­å›è°ƒå‡½æ•°çš„å‚æ•°<br>    if (typeof onRejected !== &#x27;function&#x27;) &#123;<br>      onRejected = reason =&gt; &#123;<br>        throw reason<br>      &#125;<br>    &#125;<br>    if (typeof onResolved !== &#x27;function&#x27;) &#123;<br>      onResolved = value =&gt; value<br>    &#125;<br>    return new Promise((resolve, reject) =&gt; &#123;<br>      // å°è£…try catchä¸­çš„é€»è¾‘<br>      function callback(type) &#123;<br>        try &#123;<br>          // è·å–å›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ<br>          let result = type(self.PromiseResult)<br>          if (result instanceof Promise) &#123;<br>            // resultä¸ºPromiseå¯¹è±¡<br>            // å½“resultä¸ºPromiseå¯¹è±¡æ—¶ï¼Œå®ƒçš„è¿”å›ç»“æœå°±æ˜¯thenè¿”å›çš„ç»“æœ<br>            result.then(value =&gt; &#123;<br>              resolve(value)<br>            &#125;, reason =&gt; &#123;<br>              reject(reason)<br>            &#125;)<br>          &#125; else &#123;<br>            // resultä¸ºéPromiseç±»å‹çš„æ•°æ®<br>            // å°†è¿”å›çš„Promiseå¯¹è±¡çŠ¶æ€ç½®ä¸ºæˆåŠŸ<br>            resolve(result)<br>          &#125;   <br>        &#125; catch (error) &#123;<br>          // ä¸€æ—¦æŠ›å‡ºäº†é”™è¯¯ï¼ŒPromiseçš„çŠ¶æ€ä¹Ÿä¸ºå¤±è´¥<br>          reject(error)<br>        &#125;<br>      &#125;<br>      // åœ¨è°ƒç”¨æ—¶æ˜¯æœ‰å‚æ•°çš„ï¼Œå¦‚valueå’Œreasonï¼Œè¯¥å‚æ•°ä¿å­˜åœ¨[[PromiseResult]]ä¸­<br>      if (this.PromiseState <span class="hljs-comment">=== &#x27;fulfilled&#x27;) &#123;</span><br><span class="hljs-addition">+        setTimeout(() =&gt; &#123;</span><br>          callback(onResolved)<br><span class="hljs-addition">+        &#125;)</span><br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;rejected&#x27;) &#123;</span><br><span class="hljs-addition">+        setTimeout(() =&gt; &#123;</span><br>          callback(onRejected)<br><span class="hljs-addition">+        &#125;)</span><br>      &#125; else if (this.PromiseState <span class="hljs-comment">=== &#x27;pending&#x27;) &#123;</span><br>        // ä¿å­˜å›è°ƒå‡½æ•°åˆ°Promiseå¯¹è±¡å®ä¾‹ä¸Š<br>        this.callback.push(&#123;<br>          // å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œï¼ˆå‰é¢forEachè¯­å¥è°ƒç”¨ï¼‰<br>          onResolved: function () &#123;<br>            callback(onRejected)<br>          &#125;,<br>          onRejected: function () &#123;<br>            callback(onRejected)<br>          &#125;<br>        &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;<br></code></pre></div></td></tr></table></figure></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a></div></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2021/08/16/Promise%E5%9F%BA%E7%A1%80/"><span class="hidden-mobile">PromiseåŸºç¡€</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",(function(){searchFunc("/local-search.xml","local-search-input","local-search-result")})),$("#modalSearch").on("shown.bs.modal",(function(){$("#local-search-input").focus()}))</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css"><script src="/js/boot.js"></script></body></html>