<!DOCTYPE html><html lang="zh-CN" color-mode="light"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content=""><meta name="author" content="syz"><meta name="description" content=""><title>最新的Cesium和Three的整合方法 | syzdev</title><link rel="apple-touch-icon" href="https://cdn.u1.huluxia.com/g3/M03/4D/84/wKgBOV6fGZWATbp6AAAML1Rr8NY150.png"><link rel="icon" href="https://cdn.u1.huluxia.com/g3/M03/4D/84/wKgBOV6fGZWATbp6AAAML1Rr8NY150.png"><link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/color-scheme.css"><link rel="stylesheet" href="/css/base.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css"><link rel="stylesheet" href="/css/github-markdown.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="/css/comments.css"><link rel="stylesheet" href="/css/figcaption/mac-block.css"><script defer type="text/javascript" src="/plugins/jquery.min.js"></script><link href="/plugins/jquery.fancybox.min.css" rel="stylesheet"><script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script><script src="/js/fancybox.js"></script><script>var html=document.documentElement;const colorMode=localStorage.getItem("color-mode");colorMode&&document.documentElement.setAttribute("color-mode",colorMode)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="app"><div class="header"><div class="avatar"><a href="/"><img src="/images/avatar.png" alt=""></a><div class="nickname"><a href="/">syzdev</a></div></div><div class="navbar"><ul><li class="nav-item" data-path="/"><a href="/">首页</a></li><li class="nav-item" data-path="/archives/"><a href="/archives/">归档</a></li><li class="nav-item" data-path="/tags/"><a href="/tags/">标签</a></li><li class="nav-item" data-path="/about/"><a href="/about/">关于</a></li></ul></div></div><script src="/js/activeNav.js"></script><div class="flex-container"><script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script async type="text/javascript" src="/plugins/clipboard.min.js"></script><script src="/js/codeCopy.js"></script><div class="container post-details" id="post-details"><div class="post-content"><div class="post-title">最新的Cesium和Three的整合方法</div><div class="post-attach"><span class="post-pubtime"><i class="iconfont icon-updatetime" title="更新时间"></i> 2022-07-31 11:58:00 </span><span class="post-tags"><i class="iconfont icon-tags" title="标签"></i> <span class="span--tag"><a href="/tags/WebGL/" title="WebGL"><b>#</b> WebGL</a></span></span></div><div class="markdown-body"><h1 id="1-简介"><a class="markdownIt-Anchor" href="#1-简介"></a> 1 简介</h1><p>截止2022年7月30日，最新的Cesium-Three整合示例，基于如下版本：</p><ul><li>Cesium 1.95：<a target="_blank" rel="noopener" href="https://github.com/CesiumGS/cesium/releases/tag/1.95">Release CesiumJS 1.95 · CesiumGS/cesium (github.com)</a></li><li>Three 143：<a target="_blank" rel="noopener" href="https://github.com/mrdoob/three.js/releases/tag/r143">Release r143 · mrdoob/three.js (github.com)</a></li></ul><h1 id="2-在线地址"><a class="markdownIt-Anchor" href="#2-在线地址"></a> 2 在线地址</h1><p>[ Live Demo ]：<a target="_blank" rel="noopener" href="https://syzdev.cn/cesium-docs-demo/cesium-three/cesium-three.html">Cesium integrate Threejs (syzdev.cn)</a></p><h1 id="3-屏幕截图"><a class="markdownIt-Anchor" href="#3-屏幕截图"></a> 3 屏幕截图</h1><p><img src="https://img-blog.csdnimg.cn/68714e9ce3194a43b0f33e700d4641b9.png" alt="在这里插入图片描述"></p><h1 id="4-参考资料"><a class="markdownIt-Anchor" href="#4-参考资料"></a> 4 参考资料</h1><ul><li>实现原理：<a target="_blank" rel="noopener" href="https://cesium.com/blog/2017/10/23/integrating-cesium-with-threejs/">https://cesium.com/blog/2017/10/23/integrating-cesium-with-threejs/</a></li><li>代码示例：<a target="_blank" rel="noopener" href="https://github.com/CesiumGS/cesium-threejs-experiment">https://github.com/CesiumGS/cesium-threejs-experiment</a></li></ul><h1 id="5-原理简述"><a class="markdownIt-Anchor" href="#5-原理简述"></a> 5 原理简述</h1><p>Cesium和Three都是基于WebGL的三维框架，在渲染成DOM时，本质上都是<code>canvas</code>。所以两者的集成需要解决如下几个问题：</p><ol><li>场景叠加：将两个<code>canvas</code>在DOM上叠加到一起，解决方式为将Three的<code>canvas</code>叠加在Cesium的<code>canvas</code>之上，通过CSS实现；</li><li>交互：由于屏幕上要显示两个<code>canvas</code>，所以需要关闭其中一个交互功能，在Three的<code>canvas</code>上添加CSS样式<code>pointer-events：none</code>来屏蔽其鼠标交互，主要用Cesium来实现交互。</li><li>刷新同步：关闭Cesium中的默认帧渲染<code>useDefaultRenderLoop</code>，用<code>cesium.viewer.render();</code>来手动触发帧渲染，在Three中是通过<code>requestAnimationFrame</code>来实现帧渲染的，所以在每个循环渲染帧中要同步渲染Cesium和Three的场景。</li><li>坐标：在<code>renderThreeObj()</code>方法中有详细的描述，Three场景下的3D对象，也是跟随改变其位置和方向的。</li></ol><h1 id="6-改动说明"><a class="markdownIt-Anchor" href="#6-改动说明"></a> 6 改动说明</h1><p>Cesium官方提供的示例程序“<a target="_blank" rel="noopener" href="https://github.com/CesiumGS/cesium-threejs-experiment">cesium-threejs-experiment</a>”中使用的版本如下：</p><ul><li>Cesium ^1.45.0</li><li>Three 0.87.1</li></ul><p>显然，这在现在是过时的，若用最新的Cesium和Three版本直接套用原来的代码，会出现如下问题：</p><ul><li>Cesium初始化无法找到容器</li><li>Three场景无法正确的显示，加载的模型在场景中找不到</li></ul><p>解决方法如下，注释<code>initCesium()</code>方法中Cesium初始化选项<code>creditContainer : &quot;hidecredit&quot;</code>，可以解决Cesium初始化时无法找到容器的问题：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initCesium</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  cesium.viewer = <span class="keyword">new</span> Cesium.Viewer(cesiumContainer, &#123;</span><br><span class="line">    <span class="comment">// creditContainer : &quot;hidecredit&quot;, // Cannot read properties of null (reading &#x27;appendChild&#x27;)</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>去除<code>renderThreeObj()</code>方法中的<code>three.camera.lookAt(new THREE.Vector3(0,0,0));</code>语句，并在配置Three相机矩阵之前添加<code>three.camera.lookAt(0, 0, 0)</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderThreeObj</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  three.camera.lookAt(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="comment">// here</span></span><br><span class="line">  three.camera.matrixWorld.set(...)</span><br><span class="line">  three.camera.matrixWorldInverse.set(...)</span><br><span class="line">  <span class="comment">// three.camera.lookAt(new THREE.Vector3(0,0,0));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时，需要给Three容器添加如下CSS样式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#ThreeContainer</span> <span class="selector-tag">canvas</span> &#123;</span><br><span class="line">  <span class="attribute">pointer-events</span>: none;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="7-完整代码"><a class="markdownIt-Anchor" href="#7-完整代码"></a> 7 完整代码</h1><h2 id="71-github推荐"><a class="markdownIt-Anchor" href="#71-github推荐"></a> 7.1 GitHub（推荐）</h2><p>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/syzdev/Cesium-Three">https://github.com/syzdev/Cesium-Three</a></p><p>若读者已经安装了Git，可以在指定文件夹内打开Git Bash窗口，输入如下指令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/syzdev/Cesium-Three.git</span><br></pre></td></tr></table></figure><p>该指令会将代码克隆到指定文件夹中，再通过服务发布即可访问。</p><h2 id="72-原生代码"><a class="markdownIt-Anchor" href="#72-原生代码"></a> 7.2 原生代码</h2><p>下面代码中的第三方库Cesium和Three都是以CDN的形式引入的，上述GitHub中的代码都是以本地文件的形式发布的：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=Edge,chrome=1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Cesium integrate Threejs<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Cesium 1.95 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Three.js 143 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/three@0.143.0/build/three.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">html</span>,</span></span><br><span class="line"><span class="css">    <span class="selector-tag">body</span>,</span></span><br><span class="line">    #cesiumContainer &#123;</span><br><span class="line"><span class="css">      <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="css">      <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="css">      <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">      <span class="attribute">padding</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="css">      <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .cesium-viewer .cesium-widget-credits &#123;</span><br><span class="line"><span class="css">      <span class="attribute">display</span>: none;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-id">#ThreeContainer</span> <span class="selector-tag">canvas</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="attribute">pointer-events</span>: none;</span></span><br><span class="line"><span class="css">      <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="css">      <span class="attribute">top</span>: <span class="number">0</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;cesiumContainer&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;ThreeContainer&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> three = &#123;</span></span><br><span class="line"><span class="javascript">      renderer: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">      camera: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">      scene: <span class="literal">null</span>,</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> cesium = &#123;</span></span><br><span class="line"><span class="javascript">      viewer: <span class="literal">null</span>,</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> minWGS84 = [<span class="number">115.23</span>, <span class="number">39.55</span>];</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> maxWGS84 = [<span class="number">116.23</span>, <span class="number">41.55</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> cesiumContainer = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;cesiumContainer&#x27;</span>)</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> ThreeContainer = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;ThreeContainer&#x27;</span>)</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> _3Dobjects = [] <span class="comment">// Could be any Three.js object mesh</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">_3DObject</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.threeMesh = <span class="literal">null</span> <span class="comment">// Three.js 3DObject.mesh</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.minWGS84 = <span class="literal">null</span> <span class="comment">// location bounding box</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.maxWGS84 = <span class="literal">null</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">initCesium</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      cesium.viewer = <span class="keyword">new</span> Cesium.Viewer(cesiumContainer, &#123;</span></span><br><span class="line"><span class="javascript">        useDefaultRenderLoop: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        selectionIndicator: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        homeButton: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        sceneModePicker: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        infoBox: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        navigationHelpButton: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        navigationInstructionsInitiallyVisible: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        animation: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        timeline: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        fullscreenButton: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        allowTextureFilterAnisotropic: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        baseLayerPicker: <span class="literal">false</span>,</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="comment">// contextOptions: &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//   webgl: &#123;</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     alpha: false,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     antialias: true,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     preserveDrawingBuffer: true,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     failIfMajorPerformanceCaveat: false,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     depth: true,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     stencil: false,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//     anialias: false,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">//   &#125;,</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// &#125;,</span></span></span><br><span class="line"></span><br><span class="line">        targetFrameRate: 60,</span><br><span class="line"><span class="javascript">        <span class="comment">// resolutionScale: 0.1,</span></span></span><br><span class="line"><span class="javascript">        orderIndependentTranslucency: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">        geocoder: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        imageryProvider: <span class="keyword">new</span> Cesium.ArcGisMapServerImageryProvider(&#123;</span></span><br><span class="line"><span class="javascript">          url: <span class="string">&#x27;https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer&#x27;</span>,</span></span><br><span class="line">        &#125;),</span><br><span class="line"><span class="javascript">        automaticallyTrackDataSourceClocks: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        <span class="comment">// creditContainer : &quot;hidecredit&quot;, // Cannot read properties of null (reading &#x27;appendChild&#x27;)</span></span></span><br><span class="line"><span class="javascript">        dataSources: <span class="literal">null</span>,</span></span><br><span class="line"><span class="javascript">        clock: <span class="literal">null</span>,</span></span><br><span class="line">        terrainShadows: Cesium.ShadowMode.DISABLED,</span><br><span class="line">      &#125;)</span><br><span class="line">      cesium.viewer.camera.flyTo(&#123;</span><br><span class="line">        destination: Cesium.Cartesian3.fromDegrees(</span><br><span class="line">          (minWGS84[0] + maxWGS84[0]) / 2,</span><br><span class="line">          (minWGS84[1] + maxWGS84[1]) / 2 - 1.25,</span><br><span class="line">          200000</span><br><span class="line">        ),</span><br><span class="line">        orientation: &#123;</span><br><span class="line">          heading: Cesium.Math.toRadians(0),</span><br><span class="line">          pitch: Cesium.Math.toRadians(-60),</span><br><span class="line">          roll: Cesium.Math.toRadians(0),</span><br><span class="line">        &#125;,</span><br><span class="line">        duration: 3,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">initThree</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> fov = <span class="number">45</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> width = <span class="built_in">window</span>.innerWidth</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> height = <span class="built_in">window</span>.innerHeight</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> aspect = width / height</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> near = <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> far = <span class="number">10</span> * <span class="number">1000</span> * <span class="number">1000</span></span></span><br><span class="line"><span class="javascript">      three.scene = <span class="keyword">new</span> THREE.Scene()</span></span><br><span class="line"><span class="javascript">      three.camera = <span class="keyword">new</span> THREE.PerspectiveCamera(fov, aspect, near, far)</span></span><br><span class="line"><span class="javascript">      three.renderer = <span class="keyword">new</span> THREE.WebGLRenderer(&#123; <span class="attr">alpha</span>: <span class="literal">true</span> &#125;)</span></span><br><span class="line">      ThreeContainer.appendChild(three.renderer.domElement)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">addBoxEntity</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">      cesium.viewer.entities.add(&#123;</span><br><span class="line"><span class="javascript">        name: <span class="string">&#x27;Box&#x27;</span>,</span></span><br><span class="line">        position: Cesium.Cartesian3.fromDegrees(</span><br><span class="line">          (minWGS84[0] + maxWGS84[0]) / 2,</span><br><span class="line">          (minWGS84[1] + maxWGS84[1]) / 2 - 0.5,</span><br><span class="line">          7000</span><br><span class="line">        ),</span><br><span class="line">        box: &#123;</span><br><span class="line"><span class="javascript">          dimensions: <span class="keyword">new</span> Cesium.Cartesian3(<span class="number">16000.0</span>, <span class="number">16000.0</span>, <span class="number">16000.0</span>),</span></span><br><span class="line">          material: Cesium.Color.RED.withAlpha(0.5),</span><br><span class="line"><span class="javascript">          fill: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">          outline: <span class="literal">true</span>,</span></span><br><span class="line">          outlineColor: Cesium.Color.BLACK,</span><br><span class="line">          outlineWidth: 1.0,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">addPolygonEntity</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">      cesium.viewer.entities.add(&#123;</span><br><span class="line"><span class="javascript">        name: <span class="string">&#x27;Polygon&#x27;</span>,</span></span><br><span class="line">        polygon: &#123;</span><br><span class="line">          hierarchy: Cesium.Cartesian3.fromDegreesArray([</span><br><span class="line">            minWGS84[0],</span><br><span class="line">            minWGS84[1],</span><br><span class="line">            maxWGS84[0],</span><br><span class="line">            minWGS84[1],</span><br><span class="line">            maxWGS84[0],</span><br><span class="line">            maxWGS84[1],</span><br><span class="line">            minWGS84[0],</span><br><span class="line">            maxWGS84[1],</span><br><span class="line">          ]),</span><br><span class="line">          material: Cesium.Color.PINK.withAlpha(0.4),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">addBoxGeometry</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> geometry = <span class="keyword">new</span> THREE.BoxGeometry()</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> material = <span class="keyword">new</span> THREE.MeshNormalMaterial()</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> dodecahedronMesh = <span class="keyword">new</span> THREE.Mesh(geometry, material)</span></span><br><span class="line"><span class="javascript">      dodecahedronMesh.scale.set(<span class="number">15000</span>, <span class="number">15000</span>, <span class="number">15000</span>) <span class="comment">// scale object to be visible at planet scale</span></span></span><br><span class="line"><span class="javascript">      dodecahedronMesh.position.z += <span class="number">7000.0</span> <span class="comment">// translate &quot;up&quot; in Three.js space so the &quot;bottom&quot; of the mesh is the handle</span></span></span><br><span class="line"><span class="javascript">      dodecahedronMesh.rotation.x = <span class="built_in">Math</span>.PI / <span class="number">2</span> <span class="comment">// rotate mesh for Cesium&#x27;s Y-up system</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> dodecahedronMeshYup = <span class="keyword">new</span> THREE.Group()</span></span><br><span class="line">      dodecahedronMeshYup.add(dodecahedronMesh)</span><br><span class="line"><span class="javascript">      three.scene.add(dodecahedronMeshYup) <span class="comment">// don’t forget to add it to the Three.js scene manually</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// Assign Three.js object mesh to our object array</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> _3DOB = <span class="keyword">new</span> _3DObject()</span></span><br><span class="line">      _3DOB.threeMesh = dodecahedronMeshYup</span><br><span class="line">      _3DOB.minWGS84 = minWGS84</span><br><span class="line">      _3DOB.maxWGS84 = maxWGS84</span><br><span class="line">      _3Dobjects.push(_3DOB)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">init3DObject</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// Cesium entity</span></span></span><br><span class="line">      addPolygonEntity()</span><br><span class="line">      addBoxEntity()</span><br><span class="line"><span class="javascript">      <span class="comment">// Three.js Objects</span></span></span><br><span class="line">      addBoxGeometry()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">renderCesium</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">      cesium.viewer.render()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">renderThreeObj</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// register Three.js scene with Cesium</span></span></span><br><span class="line"><span class="javascript">      three.camera.fov = Cesium.Math.toDegrees(cesium.viewer.camera.frustum.fovy) <span class="comment">// ThreeJS FOV is vertical</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// three.camera.updateProjectionMatrix();</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> cartToVec = <span class="function"><span class="keyword">function</span> (<span class="params">cart</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> THREE.Vector3(cart.x, cart.y, cart.z)</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="comment">// Configure Three.js meshes to stand against globe center position up direction</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">for</span> (<span class="keyword">let</span> id <span class="keyword">in</span> _3Dobjects) &#123;</span></span><br><span class="line">        minWGS84 = _3Dobjects[id].minWGS84</span><br><span class="line">        maxWGS84 = _3Dobjects[id].maxWGS84</span><br><span class="line"><span class="javascript">        <span class="comment">// convert lat/long center position to Cartesian3</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> center = Cesium.Cartesian3.fromDegrees(</span></span><br><span class="line">          (minWGS84[0] + maxWGS84[0]) / 2,</span><br><span class="line">          (minWGS84[1] + maxWGS84[1]) / 2</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="comment">// get forward direction for orienting model</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> centerHigh = Cesium.Cartesian3.fromDegrees(</span></span><br><span class="line">          (minWGS84[0] + maxWGS84[0]) / 2,</span><br><span class="line">          (minWGS84[1] + maxWGS84[1]) / 2,</span><br><span class="line">          1</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="comment">// use direction from bottom left to top left as up-vector</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> bottomLeft = cartToVec(</span></span><br><span class="line">          Cesium.Cartesian3.fromDegrees(minWGS84[0], minWGS84[1])</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> topLeft = cartToVec(</span></span><br><span class="line">          Cesium.Cartesian3.fromDegrees(minWGS84[0], maxWGS84[1])</span><br><span class="line">        )</span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> latDir = <span class="keyword">new</span> THREE.Vector3().subVectors(bottomLeft, topLeft).normalize()</span></span><br><span class="line"><span class="javascript">        <span class="comment">// configure entity position and orientation</span></span></span><br><span class="line">        _3Dobjects[id].threeMesh.position.copy(center)</span><br><span class="line">        _3Dobjects[id].threeMesh.lookAt(centerHigh.x, centerHigh.y, centerHigh.z)</span><br><span class="line">        _3Dobjects[id].threeMesh.up.copy(latDir)</span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="comment">// Clone Cesium Camera projection position so the</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// Three.js Object will appear to be at the same place as above the Cesium Globe</span></span></span><br><span class="line"><span class="javascript">      three.camera.matrixAutoUpdate = <span class="literal">false</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> cvm = cesium.viewer.camera.viewMatrix</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> civm = cesium.viewer.camera.inverseViewMatrix</span></span><br><span class="line"></span><br><span class="line">      three.camera.lookAt(0, 0, 0)</span><br><span class="line"></span><br><span class="line">      three.camera.matrixWorld.set(</span><br><span class="line">        civm[0],</span><br><span class="line">        civm[4],</span><br><span class="line">        civm[8],</span><br><span class="line">        civm[12],</span><br><span class="line">        civm[1],</span><br><span class="line">        civm[5],</span><br><span class="line">        civm[9],</span><br><span class="line">        civm[13],</span><br><span class="line">        civm[2],</span><br><span class="line">        civm[6],</span><br><span class="line">        civm[10],</span><br><span class="line">        civm[14],</span><br><span class="line">        civm[3],</span><br><span class="line">        civm[7],</span><br><span class="line">        civm[11],</span><br><span class="line">        civm[15]</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      three.camera.matrixWorldInverse.set(</span><br><span class="line">        cvm[0],</span><br><span class="line">        cvm[4],</span><br><span class="line">        cvm[8],</span><br><span class="line">        cvm[12],</span><br><span class="line">        cvm[1],</span><br><span class="line">        cvm[5],</span><br><span class="line">        cvm[9],</span><br><span class="line">        cvm[13],</span><br><span class="line">        cvm[2],</span><br><span class="line">        cvm[6],</span><br><span class="line">        cvm[10],</span><br><span class="line">        cvm[14],</span><br><span class="line">        cvm[3],</span><br><span class="line">        cvm[7],</span><br><span class="line">        cvm[11],</span><br><span class="line">        cvm[15]</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> width = cesiumContainer.clientWidth</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> height = cesiumContainer.clientHeight</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> aspect = width / height</span></span><br><span class="line">      three.camera.aspect = aspect</span><br><span class="line">      three.camera.updateProjectionMatrix()</span><br><span class="line">      three.renderer.setSize(width, height)</span><br><span class="line">      three.renderer.clear()</span><br><span class="line">      three.renderer.render(three.scene, three.camera)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">loop</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">      requestAnimationFrame(loop)</span><br><span class="line">      renderCesium()</span><br><span class="line">      renderThreeObj()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    initCesium() <span class="comment">// Initialize Cesium renderer</span></span></span><br><span class="line"><span class="javascript">    initThree() <span class="comment">// Initialize Three.js renderer</span></span></span><br><span class="line"><span class="javascript">    init3DObject() <span class="comment">// Initialize Three.js object mesh with Cesium Cartesian coordinate system</span></span></span><br><span class="line"><span class="javascript">    loop() <span class="comment">// Looping renderer</span></span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="prev-or-next"><div class="post-foot-next"><a href="/2022/04/24/%E8%B7%A8%E5%9F%9F%E7%9A%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%A4%84%E7%90%86%E8%B7%A8%E5%9F%9F%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95/" target="_self"><i class="iconfont icon-chevronleft"></i> <span>上一页</span></a></div><div class="post-attach"><span class="post-pubtime"><i class="iconfont icon-updatetime" title="更新时间"></i> 2022-07-31 11:58:00 </span><span class="post-tags"><i class="iconfont icon-tags" title="标签"></i> <span class="span--tag"><a href="/tags/WebGL/" title="WebGL"><b>#</b> WebGL</a></span></span></div><div class="post-foot-prev"><a href="/2022/08/02/%E5%9B%BE%E8%A7%A3WebGL&Three.js%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" target="_self"><span>下一页</span> <i class="iconfont icon-chevronright"></i></a></div></div></div><div id="btn-catalog" class="btn-catalog"><i class="iconfont icon-catalog"></i></div><div class="post-catalog hidden" id="catalog"><div class="title">目录</div><div class="catalog-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-text">1 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%9C%A8%E7%BA%BF%E5%9C%B0%E5%9D%80"><span class="toc-text">2 在线地址</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE"><span class="toc-text">3 屏幕截图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">4 参考资料</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0"><span class="toc-text">5 原理简述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%94%B9%E5%8A%A8%E8%AF%B4%E6%98%8E"><span class="toc-text">6 改动说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-text">7 完整代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#71-github%E6%8E%A8%E8%8D%90"><span class="toc-text">7.1 GitHub（推荐）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#72-%E5%8E%9F%E7%94%9F%E4%BB%A3%E7%A0%81"><span class="toc-text">7.2 原生代码</span></a></li></ol></li></ol></div></div><script src="/js/catalog.js"></script><div class="comments-container"></div></div><div class="footer"><div class="social"><ul><li><a title="github" target="_blank" rel="noopener" href="https://github.com/syzdev"><i class="iconfont icon-github"></i></a></li></ul></div><div class="footer-more"><a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a></div></div></div><div class="tools-bar"><div class="back-to-top tools-bar-item hidden"><a href="javascript: void(0)"><i class="iconfont icon-chevronup"></i></a></div><script src="/js/backtotop.js"></script><div class="search-icon tools-bar-item" id="search-icon"><a href="javascript: void(0)"><i class="iconfont icon-search"></i></a></div><div class="search-overlay hidden"><div class="search-content" tabindex="0"><div class="search-title"><span class="search-icon-input"><a href="javascript: void(0)"><i class="iconfont icon-search"></i> </a></span><input type="text" class="search-input" id="search-input" placeholder="搜索..."> <span class="search-close-icon" id="search-close-icon"><a href="javascript: void(0)"><i class="iconfont icon-close"></i></a></span></div><div class="search-result" id="search-result"></div></div></div><script type="text/javascript">var inputArea=document.querySelector("#search-input"),searchOverlayArea=document.querySelector(".search-overlay");function openOrHideSearchContent(){searchOverlayArea.classList.contains("hidden")?(searchOverlayArea.classList.remove("hidden"),document.body.classList.add("hidden")):(searchOverlayArea.classList.add("hidden"),document.body.classList.remove("hidden"))}function blurSearchContent(e){e.target===searchOverlayArea&&openOrHideSearchContent()}inputArea.onclick=function(){getSearchFile(),this.onclick=null},inputArea.onkeydown=function(){if(13==event.keyCode)return!1},document.querySelector("#search-icon").addEventListener("click",openOrHideSearchContent,!1),document.querySelector("#search-close-icon").addEventListener("click",openOrHideSearchContent,!1),searchOverlayArea.addEventListener("click",blurSearchContent,!1);var searchFunc=function(e,t,n){"use strict";var r=document.getElementById(t),a=document.getElementById(n);a.innerHTML="<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>",$.ajax({url:e,dataType:"xml",success:function(e){var t=$("entry",e).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get();a.innerHTML="",r.addEventListener("input",(function(){var e='<ul class="search-result-list">',n=this.value.trim().toLowerCase().split(/[\s\-]+/);if(a.innerHTML="",!(this.value.trim().length<=0)){if(t.forEach((function(t){var r=!0;t.title&&""!==t.title.trim()||(t.title="Untitled");var a=t.title.trim(),c=a.toLowerCase(),s=t.content.trim().replace(/<[^>]+>/g,""),i=s.toLowerCase(),l=t.url,o=-1,u=-1,h=-1;if(""!==i?n.forEach((function(e,t){o=c.indexOf(e),u=i.indexOf(e),o<0&&u<0?r=!1:(u<0&&(u=0),0==t&&(h=u))})):r=!1,r){e+="<li><a href='"+l+"' class='search-result-title'>"+a+"</a>";var d=s;if(h>=0){var p=h-20,f=h+80;p<0&&(p=0),0==p&&(f=100),f>d.length&&(f=d.length);var m=d.substr(p,f);n.forEach((function(e){var t=new RegExp(e,"gi");m=m.replace(t,'<span class="search-keyword">'+e+"</span>")})),e+='<p class="search-result-abstract">'+m+"...</p>"}e+="</li>"}})),-1===(e+="</ul>").indexOf("<li>"))return a.innerHTML="<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";a.innerHTML=e}}))},error:function(e,t,n){a.innerHTML="",404===e.status?a.innerHTML="<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>":a.innerHTML="<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>"}}),$(document).on("click","#search-close-icon",(function(){$("#search-input").val(""),$("#search-result").html("")}))},getSearchFile=function(){searchFunc("/search.xml","search-input","search-result")}</script><div class="tools-bar-item theme-icon" id="switch-color-scheme"><a href="javascript: void(0)"><i id="theme-icon" class="iconfont icon-moon"></i></a></div><script src="/js/colorscheme.js"></script></div></div></body></html>